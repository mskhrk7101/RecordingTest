<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>音声認識</title>
</head>

<body>
    <!-- <a href="test.html">JSON入力</a> -->
    <div>
        <button id="start-btn">START</button>
        <button id="stop-btn">STOP</button>
    </div>

    <div>
        音声認識中のテキスト
        <p id="process"></p>
    </div>
    <div>
        認識結果
        <ol id="results">
    </div>
    <div id="result"></div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script>
        //GAS WebアプリのURL
        const END_POINT = "https://script.google.com/macros/s/AKfycbxv54tcn6c5cr7cs6-ugnRfQBTF_OOUJxFGY1fDoG_rbqLSlzBO06HegbeKyDMGyyQZHg/exec";
        //読み書きするスプレッドシート（タブ）の番号
        const SHEET_NO = 1;
        // let dataObj = {};

        // Document.querySelector()
        // https://developer.mozilla.org/ja/docs/Web/API/Document/querySelector
        const startBtn = document.querySelector("#start-btn");
        const stopBtn = document.querySelector("#stop-btn");
        const process = document.querySelector("#process");
        const results = document.querySelector("#results");

        const recognition = new webkitSpeechRecognition();

        // 日本語を指定
        recognition.lang = "ja-JP";
        // 認識途中でも結果を得る
        recognition.interimResults = true;
        // 認識を終わらせない
        recognition.continuous = true;

        // SpeechRecognition: result イベント
        // https://developer.mozilla.org/ja/docs/Web/API/SpeechRecognition/result_event
        recognition.onresult = (event) => {
            let interimTranscript = ""; // 認識中のテキスト
            for (let i = event.resultIndex; i < event.results.length; i++) {
                let transcript = event.results[i][0].transcript;
                // console.log(event.results[i]);
                if (event.results[i].isFinal) {
                    // 音声認識が完了した場合にisFinalがtrueになる
                    let result = document.createElement("li");
                    result.innerText = transcript;
                    results.appendChild(result);
                    console.log(getFromGAS());
                    const date = getDate();
                    const text = [{ "id": "0", "name": transcript, "date": date }];
                    postToGAS(text);
                    console.log(transcript);
                } else {
                    interimTranscript += transcript;
                }
            }
            process.innerHTML = interimTranscript;
        };

        startBtn.onclick = () => {
            recognition.start();
        };

        stopBtn.onclick = () => {
            recognition.stop();
        };

        function postToGAS(Content) {
            console.log(Content);

            //データがJSONかどうかのチェック
            try {
                // JSON parseとstringifyについて
                // https://www.task-notes.com/entry/20160719/1468858991
                Content = JSON.stringify(Content);
                const checkJSON = JSON.parse(Content);
                console.log(checkJSON);
                if (checkJSON.length > 0 && Object.keys(checkJSON).length > 0) {
                    console.log("data is OK");
                } else {
                    throw "data is not array of object";
                }
            }
            catch (e) {
                alert("error:" + e);
                return;
            }

            //POST送信
            $.ajax({
                type: "POST",
                url: END_POINT,
                dataType: "json",
                data: { sheetNo: SHEET_NO, data: Content }
            })
                .then(
                    (result) => { // 成功した時の処理
                        console.log(JSON.stringify(result));
                    },
                    (error) => { // 失敗した時の処理
                        alert('Error:' + JSON.stringify(error));
                    }
                );
        }
        let aaa = "";
        function getFromGAS() {
            return $.ajax({
                type: "GET",
                url: END_POINT,
                data: { sheetNo: SHEET_NO }

            }).done((result) => {        // 成功した時の処理
                // dataObj = JSON.parse(result);
                console.log("get done:" + result);
                document.getElementById("result").value = result;
                // console.log( document.getElementById("result").value);
                // return "JJJ";

            }).fail((error) => {  // 失敗した時の処理
                alert('Error:' + JSON.stringify(error));

            }).always((data) => {// 常にやる処理
                // do something
            });

        }

        //曜日取得
        // https://www.pazru.net/js/date/1.html
        function getDate() {
            //投稿日データを変数dateに格納
            let date = new Date();

            //年・月・日・曜日を取得する
            let year = date.getFullYear();
            let month = date.getMonth() + 1;
            let week = date.getDay();
            let day = date.getDate();
            let hour = date.getHours();
            let min = date.getMinutes();
            // let seco = date.getSeconds();

            let yobi = new Array("日", "月", "火", "水", "木", "金", "土");
            const dateTime = year + "/" + month + "/" + day + "(" + yobi[week] + ")" + "" + hour + ":" + min;

            return dateTime;

        }
    </script>
</body>

</html>